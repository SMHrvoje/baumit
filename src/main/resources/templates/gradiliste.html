<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradilišta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
</head>
<body>

<div class="container p-3">
    <h2 th:text="'Gradilište ' + ${construction.naziv}"></h2>
    <form id="editConstructionForm" action="/gradiliste/edit" method="post">
        <input type="hidden" name="idGradilista" th:value="${construction.idGradilista}"/>
        <table class="table">
            <thead>
            <tr>
                <th>Naziv</th>
                <th>Adresa</th>
                <th>Voditelj</th>
                <th>Akcija</th>
            </tr>
            </thead>
            <tbody>
            <tr id="constructionRow">
                <td>
                    <span th:text="${construction.naziv}" class="view-mode-master"></span>
                    <input type="text" th:value="${construction.naziv}" th:field="*{construction.naziv}" class="edit-mode-master" style="display: none;">
                </td>
                <td>
                    <span th:text="${construction.adresa}" class="view-mode-master"></span>
                    <input type="text" th:value="${construction.adresa}" th:field="*{construction.adresa}" class="edit-mode-master" style="display: none; width: 300px;">
                </td>
                <td>
                    <select th:disabled="true" th:field="*{construction.idKorisnika}" class="edit-mode-master" style="display: none;">
                        <option th:each="voditelj : ${voditelji}" th:value="${voditelj.idkorisnika}" th:text="${voditelj.korisnickoime}"></option>
                    </select>
                    <span th:each="voditelj : ${voditelji}" th:if="${voditelj.idkorisnika == construction.idKorisnika}" th:text="${voditelj.korisnickoime}" class="view-mode-master"></span>
                </td>
                <td>
                    <div class="btn-group">
                        <button type="submit" class="edit-mode-master mx-2" style="display: none;">Spremi</button>
                        <button type="button" id="editButton" onclick="toggleEditModeMaster('constructionRow')">Izmjeni</button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </form>


    <h3>Zadaci na gradilištu</h3>
    <table class="table">
        <thead>
        <tr>
            <th>Naziv zadatka</th>
            <th>Opis zadatka</th>
            <th>Status</th>
            <th>Akcija</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="task, taskStat : ${construction.zadaci}">
            <td>
                <span th:text="${task.naziv}" class="view-mode"></span>
                <input type="text" th:value="${task.naziv}" th:field="*{construction.zadaci[__${taskStat.index}__].naziv}" class="edit-mode" style="display: none;">
            </td>
            <td>
                <span th:text="${task.opis}" class="view-mode"></span>
                <textarea th:value="${task.opis}" th:field="*{construction.zadaci[__${taskStat.index}__].opis}" rows="4" class="edit-mode" style="display: none;"></textarea>
            </td>
            <td>
                <select th:disabled="true" th:field="*{construction.zadaci[__${taskStat.index}__].idStanjaZadatka}" >
                    <option th:each="state : ${stanjaZadataka}" th:value="${state.idStanjaZadatka}" th:text="${state.naziv}"></option>
                </select>

            </td>
            <td>
                <button type="button" onclick="toggleEditMode(this)">Edit</button>
                <button type="button" onclick="deleteTask(this)" th:attr="data-taskId=${task.idGradilista}">Delete</button>
            </td>
        </tr>


        </tbody>
    </table>

    <form id="newTaskForm" action="/gradiliste/addTask" method="post">
        <input type="hidden" name="constructionId" th:value="${construction.idGradilista()}">
        <input type="text" name="naziv" placeholder="Naziv zadatka">
        <input type="text" name="opis" placeholder="Opis zadatka">
        <button type="submit">Dodaj zadatak</button>
    </form>
</div>

<script th:inline="javascript">
    function deleteTask(button) {
        var taskId = button.getAttribute('data-taskId');
        // Send AJAX request to delete task with taskId
        // Example: You can use fetch or jQuery AJAX to send the request
        // Example using fetch:
        fetch('/gradiliste/deleteTask?id=' + taskId, {
            method: 'DELETE'
        })
            .then(response => {
                if (response.ok) {
                    // Refresh the page or update the table using JavaScript
                    location.reload();
                } else {
                    console.error('Error deleting task');
                }
            })
            .catch(error => console.error('Error:', error));
    }
    function toggleEditModeMaster(rowId) {
        var row = document.getElementById(rowId);
        var viewModeElements = row.querySelectorAll('.view-mode-master');
        var editModeElements = row.querySelectorAll('.edit-mode-master');
        var selectElements = row.querySelectorAll('select');
        var editButton = document.getElementById('editButton');

        // Check if any element in edit mode is visible (indicating the row is in edit mode)
        var isInEditMode = Array.from(editModeElements).some(function(element) {
            return element.style.display !== 'none';
        });

        // Toggle between view mode and edit mode
        if (isInEditMode) {
            // Toggle back to view mode
            viewModeElements.forEach(function(element) {
                element.style.display = 'block';
            });
            editModeElements.forEach(function(element) {
                element.style.display = 'none';
            });
            // Disable select elements in view mode
            selectElements.forEach(function(select) {
                select.disabled = true;
            });
            editButton.textContent = 'Izmjeni';
        } else {
            // Toggle to edit mode
            viewModeElements.forEach(function(element) {
                element.style.display = 'none';
            });
            editModeElements.forEach(function(element) {
                element.style.display = 'block';
            });
            // Enable select elements in edit mode
            selectElements.forEach(function(select) {
                select.disabled = false;
            });
            editButton.textContent = 'Odustani';
        }
    }

    function toggleEditMode(button) {
        var row = button.closest('tr');
        var viewModeElements = row.querySelectorAll('.view-mode');
        var editModeElements = row.querySelectorAll('.edit-mode');
        var selectElements = row.querySelectorAll('select');

        // Check if any element in edit mode is visible (indicating the row is in edit mode)
        var isInEditMode = Array.from(editModeElements).some(function(element) {
            return element.style.display !== 'none';
        });

        // Toggle between view mode and edit mode
        if (isInEditMode) {
            // Toggle back to view mode
            viewModeElements.forEach(function(element) {
                element.style.display = 'block';
            });
            editModeElements.forEach(function(element) {
                element.style.display = 'none';
            });
            // Disable select elements in view mode
            selectElements.forEach(function(select) {
                select.disabled = true;
            });
        } else {
            // Toggle to edit mode
            viewModeElements.forEach(function(element) {
                element.style.display = 'none';
            });
            editModeElements.forEach(function(element) {
                element.style.display = 'block';
            });
            // Enable select elements in edit mode
            selectElements.forEach(function(select) {
                select.disabled = false;
            });
        }
    }



</script>

</body>
</html>
